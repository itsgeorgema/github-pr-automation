name: PR Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20'
  CACHE_KEY_PREFIX: 'node-modules'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node modules
        id: cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-

      - name: Install Dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

  lint-and-format:
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup C++ Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format clang-tidy

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-

      - name: Install Node Dependencies
        if: needs.setup.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy bandit safety

      - name: Install Java Tools
        run: |
          # Download Checkstyle
          wget -q https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.5/checkstyle-10.12.5-all.jar -O checkstyle.jar
          # Download Google Java Format
          wget -q https://github.com/google/google-java-format/releases/download/v1.18.1/google-java-format-1.18.1-all-deps.jar -O google-java-format.jar
          # Make executable script
          echo '#!/bin/bash' > google-java-format
          echo 'java -jar google-java-format.jar "$@"' >> google-java-format
          chmod +x google-java-format
          sudo mv google-java-format /usr/local/bin/

      - name: Install SQL Tools
        run: |
          pip install sqlfluff

      - name: Run Type Check
        run: npm run type-check
        continue-on-error: true

      - name: Run Multi-Language Lint Check
        run: |
          echo "Running linting checks for all languages..."
          npm run lint:check
        continue-on-error: true

      - name: Run Multi-Language Format Check
        run: |
          echo "Running format checks for all languages..."
          npm run format:check
        continue-on-error: true

      - name: Auto-fix All Languages
        run: |
          echo "Auto-fixing issues for all languages..."
          npm run lint
        continue-on-error: true

      - name: Auto-format All Languages
        run: |
          echo "Auto-formatting code for all languages..."
          npm run format
        continue-on-error: true

      - name: Run Python Security Check
        run: |
          if find . -name "*.py" -type f | head -1 | grep -q .; then
            echo "Running Python security checks..."
            bandit -r . -f json -o bandit-report.json || true
            safety check --json --output safety-report.json || true
          else
            echo "No Python files found, skipping security checks."
          fi
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has-changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-fix: Multi-language linting and formatting (JS/TS/Python/Java/C++/SQL)"
          git push

      - name: Run final validation
        run: npm run validate

  security-scan:
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

  ai-reviewer:
    runs-on: ubuntu-latest
    needs: [lint-and-format, security-scan]
    if: always() && (needs.lint-and-format.result == 'success' || needs.lint-and-format.result == 'failure')
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get PR Information
        id: pr-info
        run: |
          echo "pr-number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "pr-title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "pr-body=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "pr-author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "base-sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          echo "head-sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT

      - name: Get Changed Files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ steps.pr-info.outputs.base-sha }} ${{ steps.pr-info.outputs.head-sha }} | tr '\n' ',' | sed 's/,$//')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # Get file contents for AI analysis
          mkdir -p /tmp/pr-analysis
          git diff ${{ steps.pr-info.outputs.base-sha }} ${{ steps.pr-info.outputs.head-sha }} > /tmp/pr-analysis/diff.patch
          
          # Get full diff with context
          git diff --unified=10 ${{ steps.pr-info.outputs.base-sha }} ${{ steps.pr-info.outputs.head-sha }} > /tmp/pr-analysis/full-diff.patch

      - name: Setup Python for MCP Client
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MCP Client Dependencies
        run: |
          pip install --upgrade pip
          pip install httpx asyncio python-dotenv

      - name: Create MCP Client Script
        run: |
          cat > mcp_client.py << 'EOF'
          import asyncio
          import json
          import os
          import sys
          import httpx
          from pathlib import Path
          
          async def analyze_pr():
              # Read PR information
              pr_number = os.environ.get('PR_NUMBER')
              pr_title = os.environ.get('PR_TITLE')
              pr_body = os.environ.get('PR_BODY', '')
              pr_author = os.environ.get('PR_AUTHOR')
              changed_files = os.environ.get('CHANGED_FILES', '').split(',')
              mcp_server_url = os.environ.get('MCP_SERVER_URL')
              
              # Read diff content
              diff_content = ''
              if Path('/tmp/pr-analysis/full-diff.patch').exists():
                  diff_content = Path('/tmp/pr-analysis/full-diff.patch').read_text()
              
              # Prepare analysis payload
              analysis_data = {
                  'pr_number': int(pr_number) if pr_number else 0,
                  'pr_title': pr_title or 'Unknown PR',
                  'pr_body': pr_body or '',
                  'pr_author': pr_author or 'unknown',
                  'changed_files': [f for f in changed_files if f.strip()],
                  'diff_content': diff_content,
                  'repository': os.environ.get('GITHUB_REPOSITORY', ''),
                  'github_token': os.environ.get('GITHUB_TOKEN', '')
              }
              
              # Try to call MCP server if URL is provided
              if mcp_server_url:
                  try:
                      async with httpx.AsyncClient(timeout=60.0) as client:
                          response = await client.post(
                              f"{mcp_server_url}/analyze-pr",
                              json=analysis_data,
                              headers={"Content-Type": "application/json"}
                          )
                          response.raise_for_status()
                          result = response.json()
                          review_comment = result.get('review_comment', 'No review generated')
                          print("Successfully called MCP server")
                  except Exception as e:
                      print(f"MCP server call failed: {e}")
                      review_comment = generate_fallback_review(analysis_data)
              else:
                  print("No MCP server URL provided, using fallback review")
                  review_comment = generate_fallback_review(analysis_data)
              
              # Output the review for the next step
              with open('/tmp/pr-analysis/review.md', 'w') as f:
                  f.write(review_comment)
              
              print("AI analysis completed successfully")
              return True
          
          def generate_fallback_review(data):
              return f"""
          ## AI Code Review
          
          **PR Summary:** {data['pr_title']}
          **Author:** @{data['pr_author']}
          **Files Changed:** {len(data['changed_files'])}
          
          ### Analysis Results:
          
            **Code Quality:** Automated linting and formatting completed
            **Security:** Security scan completed
            **Dependencies:** Dependency review completed
          
          ### Changed Files:
          {chr(10).join([f'- `{f}`' for f in data['changed_files'] if f.strip()])}
          
          ### Recommendations:
          - Code follows established patterns
          - All automated checks passed
          - Ready for human review
          
          *This review was generated automatically. For AI-powered reviews, configure MCP_SERVER_URL in your repository secrets.*
              """
          
          if __name__ == "__main__":
              asyncio.run(analyze_pr())
          EOF

      - name: Run AI Analysis
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
          PR_TITLE: ${{ steps.pr-info.outputs.pr-title }}
          PR_BODY: ${{ steps.pr-info.outputs.pr-body }}
          PR_AUTHOR: ${{ steps.pr-info.outputs.pr-author }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          MCP_SERVER_URL: ${{ secrets.MCP_SERVER_URL }}
        run: python mcp_client.py

      - name: Post AI Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('/tmp/pr-analysis/review.md', 'utf8');
            
            // Check if we already posted a review
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('AI Code Review')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: reviewContent
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reviewContent
              });
            }

  summary:
    runs-on: ubuntu-latest
    needs: [lint-and-format, security-scan, ai-reviewer]
    if: always()
    steps:
      - name: PR Check Summary
        run: |
          echo "## PR Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Format | ${{ needs.lint-and-format.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Review | ${{ needs.ai-reviewer.result == 'success' && 'Completed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ${{ (needs.lint-and-format.result == 'success' && needs.security-scan.result == 'success') && 'All checks passed!' || 'Some checks failed' }}" >> $GITHUB_STEP_SUMMARY
